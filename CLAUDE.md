# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

> Autogenerated by `/Init`. Do not edit directly — run `/Update` to regenerate.

Obsidian vault conventions module for forge-core. Teaches AI assistants how to work with Obsidian vaults (wikilinks, frontmatter, tags, Base file queries) and provides the Draft/Promote skill authoring workflow. Rust crate + shell scripts.

## Build & Test

```bash
cargo build --release --manifest-path Cargo.toml        # build obsidian-base binary
cargo test --manifest-path Cargo.toml                    # all 26+ Rust tests
cargo test --manifest-path Cargo.toml -- <test_name>     # single test
cargo clippy --manifest-path Cargo.toml -- -D warnings   # lint
cargo fmt --manifest-path Cargo.toml --check             # format check
bash tests/test.sh                                       # shell integration tests
```

When building as part of forge-core: `make install` from the parent repo. The `bin/obsidian-base` wrapper auto-compiles on first run via `bin/_build.sh`.

Shell linting: `shellcheck hooks/*.sh bin/*.sh tests/*.sh`. Pre-commit hook runs shellcheck automatically if `git config core.hooksPath .githooks` is set.

## Architecture

Four Rust modules compose the `obsidian-base` binary — a CLI that resolves Obsidian `.base` files against a vault:

```
src/
├── lib.rs              # re-exports: base, eval, note, vault
├── vault/mod.rs        # find_vault() — walks up from path looking for .obsidian/
├── note/mod.rs         # NoteContext — parse frontmatter, extract tags/wikilinks, walk vault
├── base/mod.rs         # BaseSpec — parse .base YAML (filters, views, sort)
├── eval/mod.rs         # Expression evaluator — tokenizer → parser → AST → eval against NoteContext
└── bin/obsidian_base.rs  # CLI entry point — ties it all together
```

**Data flow:** `obsidian_base.rs` finds the vault root (`vault`), parses the `.base` file (`base`), walks all `.md` files into `NoteContext` structs (`note`), evaluates filter expressions against each note (`eval`), applies sorts, and emits JSONL or paths.

**Expression engine** (`eval`): A full tokenizer/parser/evaluator for Obsidian's Base filter DSL. Supports property chains (`file.name`, `property.key`, `this.file.folder`), string methods (`.startsWith()`, `.endsWith()`, `.contains()`, `.slice()`), functions (`hasTag()`, `hasLink()`, `contains()`), operators (`==`, `!=`, `!`), and YAML-level boolean combinators (`and: [...]`, `or: [...]`).

**Test pattern:** Each module has a sibling `tests.rs` file (`base/tests.rs`, `eval/tests.rs`, etc.). Dev dependencies: `tempfile`, `assert_cmd`, `predicates`.

## Shell Scripts

| Script | Purpose |
|--------|---------|
| `bin/obsidian-base` | Wrapper — sources `_build.sh`, lazy-compiles, then `exec`s the binary |
| `bin/_build.sh` | Shared build-on-demand logic (source, don't execute) |
| `bin/forge-draft` | Copy a module skill to `Orchestration/Skills/` with `source_module:` provenance |
| `bin/forge-promote` | Push vault skill back to module, strip non-allowed frontmatter keys, create upstream symlink |
| `hooks/session-start.sh` | Emit skill metadata for non-Claude-Code providers (uses forge-load if available, awk fallback) |
| `hooks/skill-load.sh` | DCI expansion — inject steering content + User.md overrides into skill context |

All shell scripts use `set -euo pipefail`. Use `command` prefix for `cd`/`cp`/`mv`/`rm` (aliases may intercept).

## Skills

Skills in `skills/`, each with `SKILL.md` (Claude Code frontmatter + body) and optional `SKILL.yaml` (vault-only frontmatter sidecar):

| Skill | Trigger |
|-------|---------|
| `ObsidianCLI` | Official Obsidian CLI (1.12+) — files, properties, search, links, bases, daily notes |
| `ObsidianConventions` | Wikilinks, frontmatter, tags — loaded at session start |
| `VaultOperations` | TLP access, patterns, preferences — vault file work |
| `WikiLink` | Add `[[wikilinks]]` to a document — match terms against vault notes |
| `ObsidianBase` | Resolve `.base` files — CLI preferred, binary fallback for offline |
| `ObsidianTemplates` | Template management — dual-file creation, rendering, promotion |
| `ProjectConventions` | Project note conventions — base files, embeds, Dataview |
| `Draft` | Pull module skill → vault workspace |
| `Promote` | Push vault skill → module (with review gate) |
| ~~`ObsidianREST`~~ | _(deprecated)_ Replaced by ObsidianCLI |
| ~~`ObsidianActions`~~ | _(deprecated)_ Replaced by ObsidianCLI |

## Key Conventions

- **Error handling:** `Result<T, String>` throughout — no `anyhow`/`thiserror`
- **Unsafe:** Forbidden (`#[forbid(unsafe_code)]`)
- **Clippy:** Pedantic, with `module_name_repetitions`, `must_use_candidate`, `missing_errors_doc`, `missing_panics_doc` allowed
- **Frontmatter key allowlist:** `promote.yaml` controls which keys survive promote (stripped keys go to `SKILL.yaml` sidecar)
- **User overrides:** `skills/*/User.md` (gitignored) for personal vault rules
- **Config override:** `config.yaml` (gitignored) overrides `module.yaml` — e.g., `events: []` disables SessionStart hook
- **DCI (Dynamic Context Injection):** `!` backtick lines in SKILL.md execute shell commands at skill-load time to inject dynamic content

## Plugin Discovery

Two modes: standalone plugin (`.claude-plugin/plugin.json` → `hooks/hooks.json`) or forge-core submodule (dispatch reads `defaults.yaml` module order). Module-level `hooks.json` exists for standalone use; forge-core's dispatch ignores it.
