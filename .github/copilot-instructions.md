# Copilot Instructions for forge-obsidian

## What This Project Does

forge-obsidian teaches AI coding assistants how to work with Obsidian vaults -- wikilinks, frontmatter, tags, Base file queries, and the Draft/Promote skill authoring workflow. Rust crate + shell scripts.

## High-Level Architecture

### Core Components

**src/** -- Rust crate producing the `obsidian-base` binary:
- `vault/` -- find vault root (walks up looking for `.obsidian/`)
- `note/` -- parse frontmatter, extract tags/wikilinks, walk vault
- `base/` -- parse `.base` YAML (filters, views, sort)
- `eval/` -- expression evaluator (tokenizer, parser, AST, eval against notes)
- `bin/obsidian_base.rs` -- CLI entry point

**skills/** -- 11 skill directories (SKILL.md + SKILL.yaml each):
- `ObsidianCLI` -- official Obsidian CLI (1.12+) integration
- `ObsidianConventions` -- wikilinks, frontmatter, tags
- `ObsidianBase` -- resolve `.base` files
- `ObsidianTemplates` -- template management
- `VaultOperations` -- TLP access, patterns, preferences
- `WikiLink` -- add `[[wikilinks]]` to documents
- `ProjectConventions` -- project note conventions
- `Draft` -- pull module skill to vault for editing
- `Promote` -- push vault skill back to module
- `ObsidianREST` -- (deprecated) REST API integration
- `ObsidianActions` -- (deprecated) Actions URI integration

**hooks/** -- event scripts for forge-core dispatch:
- `session-start.sh` -- emit skill metadata for non-Claude providers
- `skill-load.sh` -- DCI expansion (inject steering + user overrides)

**lib/** -- git submodule pointing to forge-lib. Provides Rust binaries for deployment and validation.

## Build, Test, Verify

```bash
cargo build --release                    # build obsidian-base binary
cargo test                               # all Rust tests
cargo clippy -- -D warnings              # lint (pedantic enabled)
cargo fmt --check                        # format check (max_width = 100)
bash tests/test.sh                       # shell integration tests
make install                             # deploy skills to all providers
make verify                              # check skills deployed correctly
make check                               # verify module structure
```

## Key Conventions

### Rust Code

- `Result<T, String>` throughout -- no `anyhow`/`thiserror`
- `unsafe` forbidden (`#[forbid(unsafe_code)]`)
- Clippy pedantic with `module_name_repetitions`, `must_use_candidate`, `missing_errors_doc`, `missing_panics_doc` allowed
- Each module has a sibling `tests.rs` file
- Dev dependencies: `tempfile`, `assert_cmd`, `predicates`

### Shell Scripts

- `#!/usr/bin/env bash` + `set -euo pipefail`
- `command` prefix for `cd`, `cp`, `mv`, `rm` (never bare -- aliases may intercept)
- Variable quoting: `"$VAR"` always

### Skill Files

- `SKILL.md` -- AI instructions with YAML frontmatter (`name`, `description`, `metadata: version:`)
- `SKILL.yaml` -- deployment sidecar with `sources:` references
- `skills/*/User.md` -- personal overrides (gitignored)

### Configuration

- `defaults.yaml` -- shipped defaults (committed)
- `config.yaml` -- user overrides (gitignored)
- `module.yaml` -- module metadata (name, version, description, events)

### Git

Conventional Commits: `type: description`. Lowercase, no period, no scope. Types: `feat`, `fix`, `docs`.

## File Organization

```
src/                        Rust crate (vault, note, base, eval modules)
skills/                     11 skill directories
hooks/                      Event scripts (session-start, skill-load)
bin/                        Shell wrappers (obsidian-base, _build.sh, forge-draft, forge-promote)
lib/                        git submodule -> forge-lib
tests/                      Shell integration tests
defaults.yaml               Default module config (committed)
config.yaml                 User overrides (gitignored)
module.yaml                 Module metadata
.claude-plugin/             Plugin manifest for Claude Code
CLAUDE.md                   Autogenerated (don't edit directly)
AGENTS.md                   Autogenerated (don't edit directly)
GEMINI.md                   Autogenerated (don't edit directly)
```

## Important Notes

- Do not edit CLAUDE.md, AGENTS.md, or GEMINI.md directly -- run `/Update` to regenerate.
- Platform directories (`.claude/`, `.gemini/`, `.codex/`, `.opencode/`) are generated by `make install` and gitignored.
- The `obsidian-base` wrapper in `bin/` auto-compiles on first run via `bin/_build.sh`.
- ObsidianREST and ObsidianActions are deprecated -- use ObsidianCLI instead.
